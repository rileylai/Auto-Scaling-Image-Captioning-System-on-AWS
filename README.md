# Auto-Scaling Image Captioning System on AWS

This project demonstrates a **highly available, scalable, and secure image captioning platform** deployed on AWS. It uses a Flask-based web interface combined with an event-driven serverless backend for asynchronous processing and storage of uploaded images.

## Features

- Flask web application running in an EC2 Auto Scaling Group
- User image uploads stored securely in S3
- Serverless backend triggered via EventBridge
- Captions generated using Gemini API
- Metadata stored in a MySQL RDS instance
- Thumbnails generated by Lambda functions
- Auto Scaling based on CPU utilization
- Secure access via IAM roles and Secrets Manager

## Architecture Overview

### Web Application Stack
- **Frontend**: Flask on EC2 in Auto Scaling Group
- **Backend**: Serverless (Lambda, EventBridge, S3, RDS)
- **Load Balancer**: Application Load Balancer (ALB)
- **Subnets**: Public (ALB, NAT) + Private (EC2, Lambda, RDS)
- **Routing**: IGW for inbound, NAT for outbound

### Diagram
![Web Architecture](https://imgur.com/a/hNVzDRl)
![Serverless Architecture](https://imgur.com/a/efi2WA2)

## Deployment Summary

### 1. EC2 with Flask App
- Hosted in private subnets (us-east-1a/b/d)
- Launched with a **Launch Template** that installs dependencies and starts `app.py`
- Connected to the ALB on port `5000`
- Security Group: allows inbound from ALB only

### 2. ALB Configuration
- Public subnets (us-east-1a/b/d)
- Listener on port `80`, forwarding to target group
- Health Check Path: `/gallery`

### 3. S3 Bucket
- Bucket Name: `image-caption-riley-2025-unique-0520`
- Structure: 
  - `pictures/` for uploads
  - `thumbnails/` for generated thumbnails
- Triggers EventBridge on upload

### 4. RDS
- MySQL in private subnet
- No public access
- Accessible only from EC2 and Lambda

### 5. Lambda Functions
- `annotation_function`: Generates caption with Gemini API
- `thumbnail_function`: Creates 128x128 thumbnail with Pillow
- Both triggered by S3 events via EventBridge

## Auto Scaling Test

### Load Test Tool
Used **ApacheBench (ab)** to simulate high traffic:

```bash
ab -n 10000 -c 100 http://<alb-dns>/gallery
```

- `-n 10000`: Total 10,000 requests
- `-c 100`: 100 concurrent users

### Observation
- CPU utilization exceeded 60% ➜ **scale-out** triggered
- EC2 instances increased from 1 to 3
- When CPU dropped below 30% ➜ **scale-in** occurred

## Security

- **IAM Role**: LabRole shared across EC2, Lambda, and RDS
- **Secrets Manager**: Stores DB credentials securely
- **Security Groups**: Fine-grained rules for inbound/outbound traffic

## Folder Structure

- app.py: Main application script that handles routing, S3/database operations, and frontend rendering.
- templates/: Directory containing HTML templates for the frontend interface.
- setup.sh: Shell script used to install all required dependencies.
- create-database.sh: Script to initialize the MySQL database schema and table.

## Future Improvements

- Add authentication to web UI
- Use WSGI (e.g., gunicorn) instead of development server
- Improve image processing concurrency
- Use Step Functions to chain Lambda executions
